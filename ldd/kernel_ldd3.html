<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><!--This file has been created with freemind2html.xsl--><head><title>字符驱动</title><link rel="stylesheet" href="kernel_ldd3.html_files/freemind2html.css" type="text/css"/><meta name="generator" content="FreeMind-XSL Stylesheet (see: http://freemind-xsl.dev.slash-me.net/ for details)"/><script type="text/javascript" src="kernel_ldd3.html_files/freemind2html.js">  
	</script><script type="text/javascript"><!--
          
               function toggle(id)
               {
                   div_el = document.getElementById(id);
                   img_el = document.getElementById('img'+id);
                   if (div_el.style.display != 'none')
                   {
          
					
                      div_el.style.display='none';
                      img_el.src = 'kernel_ldd3.html_files/show.png';
          
                   }
                   else
                   {
          
                      div_el.style.display='block';
                      img_el.src = 'kernel_ldd3.html_files/hide.png';
          
                   };
               };
          
          --></script></head><body><h1>字符驱动</h1><div style="width:96%;  padding:2%;  margin-bottom:10px;  border: 0px;  text-align:center;  vertical-align:center;"><img src="kernel_ldd3.html_files/image.png" style="margin-bottom:10px; &#9;border: 0px; &#9;text-align:center; &#9;vertical-align:center;" alt="Imagemap" usemap="#fm_imagemap"/></div><map name="fm_imagemap" id="fm_imagemap"><area shape="rect" href="#FMID_332111700FM" alt="字符驱动" title="字符驱动" coords="0,647,66,689" /><area shape="rect" href="#FMID_802837188FM" alt="scull" title="scull" coords="86,0,127,21" /><area shape="rect" href="#FMID_1054063932FM" alt="主次编号" title="主次编号" coords="86,364,151,385" /><area shape="rect" href="#FMID_1726942250FM" alt="一个主编号一个驱动" title="一个主编号一个驱动" coords="171,24,296,45" /><area shape="rect" href="#FMID_495092805FM" alt="次编号决定引用哪个设备" title="次编号决定引用哪个设备" coords="171,48,320,69" /><area shape="rect" href="#FMID_1185163139FM" alt="设备编号内部表示" title="设备编号内部表示" coords="171,84,284,105" /><area shape="rect" href="#FMID_1286686823FM" alt="MAJOR(dev_t dev) MINOR(dev_t dev) MKDEV( ..." title="MAJOR(dev_t dev) MINOR(dev_t dev) MKDEV( ..." coords="304,72,666,93" /><area shape="rect" href="#FMID_1951341559FM" alt="dev_t 32位 12主 20次 linux/kdev_t.h" title="dev_t 32位 12主 20次 linux/kdev_t.h" coords="304,96,514,117" /><area shape="rect" href="#FMID_871240374FM" alt="分配释放设备编号" title="分配释放设备编号" coords="171,156,284,177" /><area shape="rect" href="#FMID_1474748445FM" alt="linux/fs.h" title="linux/fs.h" coords="304,120,371,141" /><area shape="rect" href="#FMID_1785821731FM" alt="int register_chrdev_region(dev_t first,u ..." title="int register_chrdev_region(dev_t first,u ..." coords="304,144,691,165" /><area shape="rect" href="#FMID_751636723FM" alt="int alloc_chrdev_region(dev_t *dev,unsig ..." title="int alloc_chrdev_region(dev_t *dev,unsig ..." coords="304,168,809,189" /><area shape="rect" href="#FMID_1759977214FM" alt="void unregister_chrdev_region(dev_t firs ..." title="void unregister_chrdev_region(dev_t firs ..." coords="304,192,653,213" /><area shape="rect" href="#FMID_1685868388FM" alt="主编号动态分配" title="主编号动态分配" coords="171,264,272,285" /><area shape="rect" href="#FMID_819676075FM" alt="尽量用alloc_chrdev_region而不是register_chrdev ..." title="尽量用alloc_chrdev_region而不是register_chrdev ..." coords="292,216,608,237" /><area shape="rect" href="#FMID_979050161FM" alt="/proc/devices中可以读取设备号" title="/proc/devices中可以读取设备号" coords="292,240,479,261" /><area shape="rect" href="#FMID_236969610FM" alt="获取主编号" title="获取主编号" coords="292,288,369,309" /><area shape="rect" href="#FMID_1816458452FM" alt="scull_major != 0静态分配主设备号" title="scull_major != 0静态分配主设备号" coords="389,264,586,285" /><area shape="rect" href="#FMID_1156308804FM" alt="scull_major == 0 动态分配主设备号" title="scull_major == 0 动态分配主设备号" coords="389,300,593,321" /><area shape="rect" href="#FMID_1226264816FM" alt="alloc_chrdev_region" title="alloc_chrdev_region" coords="613,288,736,309" /><area shape="rect" href="#FMID_215282782FM" alt="MAJOR(dev)" title="MAJOR(dev)" coords="613,312,693,333" /><area shape="rect" href="#FMID_1298640210FM" alt="重要数据结构" title="重要数据结构" coords="171,520,260,541" /><area shape="rect" href="#FMID_1456670018FM" alt="file_operations fops" title="file_operations fops" coords="280,518,401,539" /><area shape="rect" href="#FMID_934679588FM" alt="struct module *owner用来在它的操作还在被使用时阻止卸载 TH ..." title="struct module *owner用来在它的操作还在被使用时阻止卸载 TH ..." coords="421,336,939,357" /><area shape="rect" href="#FMID_155075103FM" alt="loff_t (*lseek)(struct file *,loff_t int ..." title="loff_t (*lseek)(struct file *,loff_t int ..." coords="421,372,627,393" /><area shape="rect" href="#FMID_1678582966FM" alt="改变文件中读写位置 返回新位置" title="改变文件中读写位置 返回新位置" coords="647,360,835,381" /><area shape="rect" href="#FMID_253964915FM" alt="long offset" title="long offset" coords="647,384,720,405" /><area shape="rect" href="#FMID_1330041247FM" alt="ssize_t (*read)(struct file *,char __use ..." title="ssize_t (*read)(struct file *,char __use ..." coords="421,420,722,441" /><area shape="rect" href="#FMID_571188745FM" alt="用来从设备中获取数据" title="用来从设备中获取数据" coords="742,408,879,429" /><area shape="rect" href="#FMID_815649344FM" alt="返回读取字节数 signed size本地整数类型" title="返回读取字节数 signed size本地整数类型" coords="742,432,974,453" /><area shape="rect" href="#FMID_51784451FM" alt="ssize_t (*aio_read)(struct kiocb *,char  ..." title="ssize_t (*aio_read)(struct kiocb *,char  ..." coords="421,468,755,489" /><area shape="rect" href="#FMID_1913455061FM" alt="初始化异步读" title="初始化异步读" coords="775,456,864,477" /><area shape="rect" href="#FMID_922216350FM" alt="为NULL 则read同步读" title="为NULL 则read同步读" coords="775,480,908,501" /><area shape="rect" href="#FMID_1483859229FM" alt="ssize_t (*write)(struct file *,const cha ..." title="ssize_t (*write)(struct file *,const cha ..." coords="421,516,760,537" /><area shape="rect" href="#FMID_1203467837FM" alt="发送数据设备" title="发送数据设备" coords="780,504,869,525" /><area shape="rect" href="#FMID_854486273FM" alt="返回写的字节数" title="返回写的字节数" coords="780,528,881,549" /><area shape="rect" href="#FMID_455641041FM" alt="ssize_t (*aio_write)(struct kiocb *,cons ..." title="ssize_t (*aio_write)(struct kiocb *,cons ..." coords="421,552,797,573" /><area shape="rect" href="#FMID_1774156409FM" alt="int (*readdir)(struct file *,void *,fill ..." title="int (*readdir)(struct file *,void *,fill ..." coords="421,578,656,599" /><area shape="rect" href="#FMID_909618747FM" alt="读取目录 仅对文件系统" title="读取目录 仅对文件系统" coords="676,576,816,597" /><area shape="rect" href="#FMID_310142136FM" alt="unsigned int (*poll)(struct file *,struc ..." title="unsigned int (*poll)(struct file *,struc ..." coords="421,626,746,647" /><area shape="rect" href="#FMID_1678283319FM" alt="poll epoll select查询对一个或多个文件是否会阻塞" title="poll epoll select查询对一个或多个文件是否会阻塞" coords="766,602,1045,623" /><area shape="rect" href="#FMID_416584856FM" alt="返回一个只是非阻塞读写可能的位掩码" title="返回一个只是非阻塞读写可能的位掩码" coords="766,626,987,647" /><area shape="rect" href="#FMID_845363080FM" alt="提供给内核信息调用进程直到Ｉ/Ｏ可能 poll为ＮＵＬＬ则假定不阻塞的可读可写" title="提供给内核信息调用进程直到Ｉ/Ｏ可能 poll为ＮＵＬＬ则假定不阻塞的可读可写" coords="766,650,1207,671" /><area shape="rect" href="#FMID_585444121FM" alt="int (*ioctl)(struct inode *,struct file  ..." title="int (*ioctl)(struct inode *,struct file  ..." coords="421,674,789,695" /><area shape="rect" href="#FMID_1408807553FM" alt="int (*mmap)(struct file *,struct vm_area ..." title="int (*mmap)(struct file *,struct vm_area ..." coords="421,698,704,719" /><area shape="rect" href="#FMID_1041208982FM" alt="字符设备注册" title="字符设备注册" coords="86,758,175,779" /><area shape="rect" href="#FMID_1564951494FM" alt="cdev_alloc cdev_init" title="cdev_alloc cdev_init" coords="195,722,317,743" /><area shape="rect" href="#FMID_299546561FM" alt="cdev_add cdev_del" title="cdev_add cdev_del" coords="195,746,311,767" /><area shape="rect" href="#FMID_374770345FM" alt="scull_dev表示每个设备" title="scull_dev表示每个设备" coords="195,782,332,803" /><area shape="rect" href="#FMID_1349505332FM" alt="scull_setup_cdev" title="scull_setup_cdev" coords="352,770,457,791" /><area shape="rect" href="#FMID_1550380067FM" alt="老方法register_chrdev unregister_chrdev" title="老方法register_chrdev unregister_chrdev" coords="352,794,586,815" /><area shape="rect" href="#FMID_1227945138FM" alt="open和release" title="open和release" coords="86,890,179,911" /><area shape="rect" href="#FMID_825711823FM" alt="open" title="open" coords="199,854,243,875" /><area shape="rect" href="#FMID_1579741650FM" alt="1.获取包含inode-&gt;icdev的scull_dev" title="1.获取包含inode-&gt;icdev的scull_dev" coords="263,818,467,839" /><area shape="rect" href="#FMID_1453988959FM" alt="2.flip-&gt;private_data=dev" title="2.flip-&gt;private_data=dev" coords="263,842,409,863" /><area shape="rect" href="#FMID_1229255120FM" alt="3.判断flip-&gt;f_flags&amp;O_ACCMODE" title="3.判断flip-&gt;f_flags&amp;O_ACCMODE" coords="263,866,451,887" /><area shape="rect" href="#FMID_708764330FM" alt="4.3为真 则scull_trim(dev)" title="4.3为真 则scull_trim(dev)" coords="263,890,415,911" /><area shape="rect" href="#FMID_1147777869FM" alt="release" title="release" coords="199,938,253,959" /><area shape="rect" href="#FMID_463932681FM" alt="1.一个release对应一个open" title="1.一个release对应一个open" coords="273,914,436,935" /><area shape="rect" href="#FMID_539109823FM" alt="2.close在文件结构计数到0才调用release方法" title="2.close在文件结构计数到0才调用release方法" coords="273,938,527,959" /><area shape="rect" href="#FMID_849900270FM" alt="3.每次调用close都会调用flush" title="3.每次调用close都会调用flush" coords="273,962,449,983" /><area shape="rect" href="#FMID_1065532603FM" alt="scull内存使用" title="scull内存使用" coords="86,1036,175,1057" /><area shape="rect" href="#FMID_847205131FM" alt="&lt;linux/slab.h&gt;" title="&lt;linux/slab.h&gt;" coords="195,1034,288,1055" /><area shape="rect" href="#FMID_1354558575FM" alt="kmalloc() kfree()" title="kmalloc() kfree()" coords="308,986,413,1007" /><area shape="rect" href="#FMID_1756764416FM" alt="scull中 每个设备是一个指针链表 每个都指向一个scull_dev" title="scull中 每个设备是一个指针链表 每个都指向一个scull_dev" coords="308,1010,631,1031" /><area shape="rect" href="#FMID_579932936FM" alt="改变quantum" title="改变quantum" coords="308,1058,398,1079" /><area shape="rect" href="#FMID_1105386349FM" alt="编译时改变SCULL_QUTANTUM SCULL_QSET" title="编译时改变SCULL_QUTANTUM SCULL_QSET" coords="418,1034,664,1055" /><area shape="rect" href="#FMID_1232185246FM" alt="模块加载时设定scull_qset scull_quantum" title="模块加载时设定scull_qset scull_quantum" coords="418,1058,651,1079" /><area shape="rect" href="#FMID_1625422547FM" alt="ioctl运行时改变当前值和缺省值" title="ioctl运行时改变当前值和缺省值" coords="418,1082,602,1103" /><area shape="rect" href="#FMID_1560617353FM" alt="读写" title="读写" coords="86,1134,127,1155" /><area shape="rect" href="#FMID_776692320FM" alt="scull_read" title="scull_read" coords="147,1108,217,1129" /><area shape="rect" href="#FMID_162643573FM" alt="copy_to_user(void __user *to,const void  ..." title="copy_to_user(void __user *to,const void  ..." coords="237,1106,621,1127" /><area shape="rect" href="#FMID_578361451FM" alt="scull_write" title="scull_write" coords="147,1132,220,1153" /><area shape="rect" href="#FMID_1974085255FM" alt="readv和writev" title="readv和writev" coords="147,1158,239,1179" /><area shape="rect" href="#FMID_565708230FM" alt="struct iovec{void __user *iov_base;__ker ..." title="struct iovec{void __user *iov_base;__ker ..." coords="259,1156,582,1177" /><area shape="rect" href="#FMID_213656947FM" alt="使用新设备" title="使用新设备" coords="86,1182,163,1203" /><area shape="rect" href="#FMID_483692435FM" alt="FAQ" title="FAQ" coords="86,1254,125,1275" /><area shape="rect" href="#FMID_1435784217FM" alt="__user宏" title="__user宏" coords="145,1230,207,1251" /><area shape="rect" href="#FMID_1137139095FM" alt="#ifdef __CHECKER__ #define  __user_attri ..." title="#ifdef __CHECKER__ #define  __user_attri ..." coords="227,1206,633,1227" /><area shape="rect" href="#FMID_507048780FM" alt="用来检查错误 检查访问地址的代码是否有问题" title="用来检查错误 检查访问地址的代码是否有问题" coords="227,1230,487,1251" /><area shape="rect" href="#FMID_431573519FM" alt="sparse静态语法检查工具 附加C=1调用sparse检查代码" title="sparse静态语法检查工具 附加C=1调用sparse检查代码" coords="227,1254,528,1275" /><area shape="rect" href="#FMID_157584228FM" alt="主次设备号" title="主次设备号" coords="145,1290,222,1311" /><area shape="rect" href="#FMID_440712873FM" alt="主设备号确定驱动程序" title="主设备号确定驱动程序" coords="242,1278,379,1299" /><area shape="rect" href="#FMID_1802497378FM" alt="次设备号确定对应驱动程序的具体设备" title="次设备号确定对应驱动程序的具体设备" coords="242,1302,463,1323" /></map>

<div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65543&quot;)" id="imgN65543"/><a id="FMID_332111700FM"/><div class="nodecontent">字符驱动</div><div class="content" id="N65543"><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65549&quot;)" id="imgN65549"/><a id="FMID_802837188FM"/><div class="nodecontent">scull</div><div class="content" id="N65549"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1193841615FM"/><div class="nodecontent">scull0-3 全局永久</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1540273098FM"/><div class="nodecontent">scullpipe0-3先入先出 阻塞/非阻塞读写</div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65569&quot;)" id="imgN65569"/><a id="FMID_1115595684FM"/><div class="nodecontent">scullsingle scullpriv sculluid scullwuid 和scull0相似</div><div class="content" id="N65569"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1080713894FM"/><div class="nodecontent">scullsingle一次只允许一个进程使用</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1746917963FM"/><div class="nodecontent">scullpriv对每个虚拟终端是私有</div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65587&quot;)" id="imgN65587"/><a id="FMID_1923953408FM"/><div class="nodecontent">sculluid 和scullwuid可以多次打开 一次只能是一个用户</div><div class="content" id="N65587"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1739487320FM"/><div class="nodecontent">前者返回设备忙的错误</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1081733695FM"/><div class="nodecontent">后者实现阻塞打开</div></div></div></div></div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_169189050FM"/><div class="nodecontent"/></div></div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65614&quot;)" id="imgN65614"/><a id="FMID_1054063932FM"/><div class="nodecontent">主次编号</div><div class="content" id="N65614"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1726942250FM"/><div class="nodecontent">一个主编号一个驱动</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_495092805FM"/><div class="nodecontent">次编号决定引用哪个设备</div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65633&quot;)" id="imgN65633"/><a id="FMID_1185163139FM"/><div class="nodecontent">设备编号内部表示</div><div class="content" id="N65633"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1286686823FM"/><div class="nodecontent">MAJOR(dev_t dev) MINOR(dev_t dev) MKDEV(int major,int minor)</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1951341559FM"/><div class="nodecontent">dev_t 32位 12主 20次 linux/kdev_t.h</div></div></div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65652&quot;)" id="imgN65652"/><a id="FMID_871240374FM"/><div class="nodecontent">分配释放设备编号</div><div class="content" id="N65652"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1474748445FM"/><div class="nodecontent">linux/fs.h</div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65664&quot;)" id="imgN65664"/><a id="FMID_1785821731FM"/><div class="nodecontent">int register_chrdev_region(dev_t first,unsigned int count,char *name);</div><div class="content" id="N65664"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_101550217FM"/><div class="nodecontent">first 起始设备编号</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_671789011FM"/><div class="nodecontent">count是连续编号的总数 太大溢出到下一个次编号</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_83146685FM"/><div class="nodecontent">name是链接到这个范围的设备的名字/proc/devices /proc/sysfs</div></div></div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65690&quot;)" id="imgN65690"/><a id="FMID_751636723FM"/><div class="nodecontent">int alloc_chrdev_region(dev_t *dev,unsigned int firstminor ,unsigned int count,char *name);</div><div class="content" id="N65690"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_168156763FM"/><div class="nodecontent">dev是一个只输出的参数</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1706272048FM"/><div class="nodecontent">firstminor是第一个次设备编号</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1147324425FM"/><div class="nodecontent">count和name同register_chrdev_region</div></div></div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1759977214FM"/><div class="nodecontent">void unregister_chrdev_region(dev_t first , unsigned int count);</div></div></div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65723&quot;)" id="imgN65723"/><a id="FMID_1685868388FM"/><div class="nodecontent">主编号动态分配</div><div class="content" id="N65723"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_819676075FM"/><div class="nodecontent">尽量用alloc_chrdev_region而不是register_chrdev_region</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_979050161FM"/><div class="nodecontent">/proc/devices中可以读取设备号</div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65741&quot;)" id="imgN65741"/><a id="FMID_236969610FM"/><div class="nodecontent">获取主编号</div><div class="content" id="N65741"><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65747&quot;)" id="imgN65747"/><a id="FMID_1816458452FM"/><div class="nodecontent">scull_major != 0静态分配主设备号</div><div class="content" id="N65747"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1202371730FM"/><div class="nodecontent">MKDEV</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_211173919FM"/><div class="nodecontent">register_chrdev_region</div></div></div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65767&quot;)" id="imgN65767"/><a id="FMID_1156308804FM"/><div class="nodecontent">scull_major == 0 动态分配主设备号</div><div class="content" id="N65767"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1226264816FM"/><div class="nodecontent">alloc_chrdev_region</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_215282782FM"/><div class="nodecontent">MAJOR(dev)</div></div></div></div></div></div></div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65788&quot;)" id="imgN65788"/><a id="FMID_1298640210FM"/><div class="nodecontent">重要数据结构</div><div class="content" id="N65788"><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65794&quot;)" id="imgN65794"/><a id="FMID_1456670018FM"/><div class="nodecontent">file_operations fops</div><div class="content" id="N65794"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_934679588FM"/><div class="nodecontent">struct module *owner用来在它的操作还在被使用时阻止卸载 THIS_MODULE &lt;linux/module.h&gt;</div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65806&quot;)" id="imgN65806"/><a id="FMID_155075103FM"/><div class="nodecontent">loff_t (*lseek)(struct file *,loff_t int);</div><div class="content" id="N65806"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1678582966FM"/><div class="nodecontent">改变文件中读写位置 返回新位置</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_253964915FM"/><div class="nodecontent">long offset</div></div></div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65825&quot;)" id="imgN65825"/><a id="FMID_1330041247FM"/><div class="nodecontent">ssize_t (*read)(struct file *,char __user *,size_t,loff_t*)</div><div class="content" id="N65825"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_571188745FM"/><div class="nodecontent">用来从设备中获取数据</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_815649344FM"/><div class="nodecontent">返回读取字节数 signed size本地整数类型</div></div></div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65844&quot;)" id="imgN65844"/><a id="FMID_51784451FM"/><div class="nodecontent">ssize_t (*aio_read)(struct kiocb *,char __user *,size_t ,loff_t);</div><div class="content" id="N65844"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1913455061FM"/><div class="nodecontent">初始化异步读</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_922216350FM"/><div class="nodecontent">为NULL 则read同步读</div></div></div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65863&quot;)" id="imgN65863"/><a id="FMID_1483859229FM"/><div class="nodecontent">ssize_t (*write)(struct file *,const char __user*,size_t,loff_t *);</div><div class="content" id="N65863"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1203467837FM"/><div class="nodecontent">发送数据设备</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_854486273FM"/><div class="nodecontent">返回写的字节数</div></div></div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65882&quot;)" id="imgN65882"/><a id="FMID_455641041FM"/><div class="nodecontent">ssize_t (*aio_write)(struct kiocb *,const char __user *,size_t,loff_t *);</div><div class="content" id="N65882"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_207480369FM"/><div class="nodecontent">初始化异步写</div></div></div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65896&quot;)" id="imgN65896"/><a id="FMID_1774156409FM"/><div class="nodecontent">int (*readdir)(struct file *,void *,filldir_t);</div><div class="content" id="N65896"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_909618747FM"/><div class="nodecontent">读取目录 仅对文件系统</div></div></div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65909&quot;)" id="imgN65909"/><a id="FMID_310142136FM"/><div class="nodecontent">unsigned int (*poll)(struct file *,struct poll_table_struct *);</div><div class="content" id="N65909"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1678283319FM"/><div class="nodecontent">poll epoll select查询对一个或多个文件是否会阻塞</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_416584856FM"/><div class="nodecontent">返回一个只是非阻塞读写可能的位掩码</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_845363080FM"/><div class="nodecontent">提供给内核信息调用进程直到Ｉ/Ｏ可能 poll为ＮＵＬＬ则假定不阻塞的可读可写</div></div></div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_585444121FM"/><div class="nodecontent">int (*ioctl)(struct inode *,struct file *,unsigned int ,unsigned long);</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1408807553FM"/><div class="nodecontent">int (*mmap)(struct file *,struct vm_area_struct *);</div></div></div></div></div></div></div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65949&quot;)" id="imgN65949"/><a id="FMID_1041208982FM"/><div class="nodecontent">字符设备注册</div><div class="content" id="N65949"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1564951494FM"/><div class="nodecontent">cdev_alloc cdev_init</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_299546561FM"/><div class="nodecontent">cdev_add cdev_del</div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65968&quot;)" id="imgN65968"/><a id="FMID_374770345FM"/><div class="nodecontent">scull_dev表示每个设备</div><div class="content" id="N65968"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1349505332FM"/><div class="nodecontent">scull_setup_cdev</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1550380067FM"/><div class="nodecontent">老方法register_chrdev unregister_chrdev</div></div></div></div></div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65988&quot;)" id="imgN65988"/><a id="FMID_1227945138FM"/><div class="nodecontent">open和release</div><div class="content" id="N65988"><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N65995&quot;)" id="imgN65995"/><a id="FMID_825711823FM"/><div class="nodecontent">open</div><div class="content" id="N65995"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1579741650FM"/><div class="nodecontent">1.获取包含inode-&gt;icdev的scull_dev</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1453988959FM"/><div class="nodecontent">2.flip-&gt;private_data=dev</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1229255120FM"/><div class="nodecontent">3.判断flip-&gt;f_flags&amp;O_ACCMODE</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_708764330FM"/><div class="nodecontent">4.3为真 则scull_trim(dev)</div></div></div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N66026&quot;)" id="imgN66026"/><a id="FMID_1147777869FM"/><div class="nodecontent">release</div><div class="content" id="N66026"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_463932681FM"/><div class="nodecontent">1.一个release对应一个open</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_539109823FM"/><div class="nodecontent">2.close在文件结构计数到0才调用release方法</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_849900270FM"/><div class="nodecontent">3.每次调用close都会调用flush</div></div></div></div></div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N66052&quot;)" id="imgN66052"/><a id="FMID_1065532603FM"/><div class="nodecontent">scull内存使用</div><div class="content" id="N66052"><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N66059&quot;)" id="imgN66059"/><a id="FMID_847205131FM"/><div class="nodecontent">&lt;linux/slab.h&gt;</div><div class="content" id="N66059"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1354558575FM"/><div class="nodecontent">kmalloc() kfree()</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1756764416FM"/><div class="nodecontent">scull中 每个设备是一个指针链表 每个都指向一个scull_dev</div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N66077&quot;)" id="imgN66077"/><a id="FMID_579932936FM"/><div class="nodecontent">改变quantum</div><div class="content" id="N66077"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1105386349FM"/><div class="nodecontent">编译时改变SCULL_QUTANTUM SCULL_QSET</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1232185246FM"/><div class="nodecontent">模块加载时设定scull_qset scull_quantum</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1625422547FM"/><div class="nodecontent">ioctl运行时改变当前值和缺省值</div></div></div></div></div></div></div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N66104&quot;)" id="imgN66104"/><a id="FMID_1560617353FM"/><div class="nodecontent">读写</div><div class="content" id="N66104"><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N66111&quot;)" id="imgN66111"/><a id="FMID_776692320FM"/><div class="nodecontent">scull_read</div><div class="content" id="N66111"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_162643573FM"/><div class="nodecontent">copy_to_user(void __user *to,const void *from,unsigned long count);</div></div></div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N66124&quot;)" id="imgN66124"/><a id="FMID_578361451FM"/><div class="nodecontent">scull_write</div><div class="content" id="N66124"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_683273391FM"/><div class="nodecontent">copy_from_user(void *to,const _user *from,unsigned long count);</div></div></div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N66138&quot;)" id="imgN66138"/><a id="FMID_1974085255FM"/><div class="nodecontent">readv和writev</div><div class="content" id="N66138"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_565708230FM"/><div class="nodecontent">struct iovec{void __user *iov_base;__kernel_size_t iov_len};</div></div></div></div></div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N66152&quot;)" id="imgN66152"/><a id="FMID_213656947FM"/><div class="nodecontent">使用新设备</div><div class="content" id="N66152"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1787543411FM"/><div class="nodecontent">strace跟踪</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1139177773FM"/><div class="nodecontent">/dev/scull0</div></div></div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N66173&quot;)" id="imgN66173"/><a id="FMID_483692435FM"/><div class="nodecontent">FAQ</div><div class="content" id="N66173"><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N66180&quot;)" id="imgN66180"/><a id="FMID_1435784217FM"/><div class="nodecontent">__user宏</div><div class="content" id="N66180"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1137139095FM"/><div class="nodecontent">#ifdef __CHECKER__ #define  __user_attribute((noderef,address_space(1)))</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_507048780FM"/><div class="nodecontent">用来检查错误 检查访问地址的代码是否有问题</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_431573519FM"/><div class="nodecontent">sparse静态语法检查工具 附加C=1调用sparse检查代码</div></div></div></div><div class="node"><img src="kernel_ldd3.html_files/hide.png" class="hideshow" alt="hide" onClick="toggle(&quot;N66205&quot;)" id="imgN66205"/><a id="FMID_157584228FM"/><div class="nodecontent">主次设备号</div><div class="content" id="N66205"><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_440712873FM"/><div class="nodecontent">主设备号确定驱动程序</div></div><div class="node"><img src="kernel_ldd3.html_files/leaf.png" class="hideshow" alt="leaf"/><a id="FMID_1802497378FM"/><div class="nodecontent">次设备号确定对应驱动程序的具体设备</div></div></div></div></div></div></div></div>
</body></html>